# 多图实况动态 (Multi-Image Live Photo) 下载逻辑说明

本文档以动态 ID `1145003199878397958`（共 9 张实况图片）为例，说明程序如何处理包含多个 Live Photo 的动态。
> *完整的数据样本可参考：[docs/examples/2025-12-11_1145003199878397958.json](./docs/examples/2025-12-11_1145003199878397958.json)*

## 1\. 数据源结构分析

程序解析后的 JSON 数据是一个列表（List），其结构如下：

  * **Index 0**: 包含 `module_top` 等详细信息的原始元数据（程序通常跳过此项用于下载，仅用于获取发布时间等全局信息）。
  * **Index 1 \~ N**: 经过 `gallery-dl` 处理后的扁平化图片对象。**每一个对象对应动态中的一张图片（及其对应的实况视频）。**

### 关键数据片段 (以第 1 张和第 9 张为例)

程序通过遍历 JSON 列表的 `[1:]` 切片来获取每一项数据。

**第 1 张图片 (Index 1):**

```json
[
    3,
    "http://i0.hdslb.com/.../live_48ff....jpg", 
    {
        // ...
        "num": 1, // 标识这是第1张
        
        // [静态图源]
        "url": "http://i0.hdslb.com/bfs/new_dyn/live_48ffb53d51a3e46d54cff7140226ab4631968078.jpg",
        
        // [实况视频源] 
        "live_url": "https://i0.hdslb.com/bfs/dyn_video/_000007a8l657ij6r2299ohx40swpmhb-1-152111110022.mp4",
        
        "width": 3024,
        "height": 4032
    }
]
```

**第 9 张图片 (Index 9):**

```json
[
    3,
    "http://i0.hdslb.com/.../live_70ed....jpg",
    {
        // ...
        "num": 9, // 标识这是第9张
        
        // [静态图源]
        "url": "http://i0.hdslb.com/bfs/new_dyn/live_70edbdaf570a633bc2b103e5dc1b53f331968078.jpg",
        
        // [实况视频源]
        "live_url": "https://i0.hdslb.com/bfs/dyn_video/_000021m452yfjjru12pv4j9m8d1oxdb-1-152111110022.mp4"
    }
]
```

## 2\. 处理流程 (Processing Logic)

程序在 `PostHandler` 中使用循环处理该列表。

### 步骤 A：遍历资源列表

程序跳过索引 0，从索引 1 开始遍历。

```python
# 伪代码逻辑
for index, item in enumerate(json_data[1:]):
    current_p = index + 1  # 计算当前是第几P (1, 2, ... 9)
    meta = item[-1]        # 获取字典数据
```

### 步骤 B：并行提取与下载

对于循环中的**每一个** item，程序都会执行“双重下载”检查：

| 资源类型 | 提取字段 | 判断逻辑 | 动作 | 文件名生成规则 |
| :--- | :--- | :--- | :--- | :--- |
| **静态图** | `url` | 始终存在 | **必须下载** | `{Date}_{ID}_{P}.jpg` |
| **实况视频** | `live_url` | `if meta.get('live_url')` | **按需下载** | `{Date}_{ID}_{P}.mp4` |

*注：`{P}` 对应循环中的当前序号。*

## 3\. 实际执行结果示例

基于提供的 JSON 文件，程序将按以下顺序生成 18 个文件（9张图 + 9个视频）：

**第 1 次循环 (P1):**

  * 读取 `url`: `.../live_48ff....jpg` -\> 下载为 `2025-12-11_1145003199878397958_1.jpg`
  * 读取 `live_url`: `.../000007a8....mp4` -\> 下载为 `2025-12-11_1145003199878397958_1.mp4`

**... (中间 P2 - P8 省略) ...**

**第 9 次循环 (P9):**

  * 读取 `url`: `.../live_70ed....jpg` -\> 下载为 `2025-12-11_1145003199878397958_9.jpg`
  * 读取 `live_url`: `.../000021m4....mp4` -\> 下载为 `2025-12-11_1145003199878397958_9.mp4`

## 4\. 异常处理与增量逻辑

  * **部分实况**：如果 9 张图中只有第 3 张是实况，则只有第 3 次循环会触发 `live_url` 下载，其他循环只下载图片。
  * **增量补充**：在增量模式下，如果本地已存在 JSON 记录，程序仍会遍历检查本地文件夹中是否缺少对应的 `_X.mp4` 文件。如果发现 JSON 中有 `live_url` 但本地无 MP4 文件，会自动补充下载。