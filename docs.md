# 思路
这个程序的思路可以精炼并优化如下：

该程序的核心工作流程是利用 `gallery-dl` 工具自动化抓取Bilibili用户的动态，并将其整理保存到本地。具体步骤如下：

1.  **获取动态列表**：程序首先通过向用户的Bilibili空间地址（例如 `https://space.bilibili.com/35117822/article`）传入 `gallery-dl` 工具，以获取包含该用户所有动态地址的元数据列表。
2.  **提取用户名**：由于初始获取的元数据中不包含用户名，程序会针对每一条动态地址进行独立的解析。在此过程中，它会从单条动态返回的详细元数据中提取出“username”字段，例如“好喜欢蜜桃四季春”。
3.  **下载与保存**：
    * 接着，程序会从该动态的详细元数据中查找并下载所有关联的图片。
    * 同时，程序还会提取并保存一系列重要字段到本地文件。这些字段包括：
        * `"url"`（动态链接）
        * `"id_str"`（动态ID）
        * `"username"`（用户名称）
        * `"pub_ts"` 和 `"pub_time"`（发布时间戳及格式化时间）
        * `"title"`（标题）
        * `"content"`（正文内容）
        * `"stats"`（包含点赞、评论、转发、收藏数的统计数据）

# 流程
这个程序的核心是一个自动化下载器，它通过调用外部工具 `gallery-dl` 来抓取Bilibili用户的动态，并将其整理保存到本地文件夹。整个流程可以分为以下几个步骤：

1.  **用户列表和配置读取**：
    * 程序首先从 `src/config.py` 文件中读取需要处理的用户数字ID列表。
    * 它还会检查一个手动映射表 `USER_ID_TO_NAME_MAP`。这个映射表是确定本地文件夹名称的第一优先来源。

2.  **获取用户动态URL列表**：
    * 对于列表中的每个用户，程序会使用 `BilibiliAPI` 类中的 `get_initial_metadata` 方法，向用户的Bilibili空间地址发送请求。这个请求会返回一个包含该用户所有动态URL的元数据列表，但**这个初始元数据中不包含用户的详细信息，比如用户名**。这个元数据会被保存在本地 `metadata/step1` 文件夹中。

3.  **智能确定用户文件夹名称**：
    * 由于初始元数据中没有用户名，程序会调用 `FolderNameResolver` 类来决定本地的文件夹名称。
    * 它遵循一个三级回退策略：
        * **最高优先级**：检查 `config.py` 中的手动映射名称。
        * **第二优先级**：如果映射不存在，程序会从动态URL列表中选取第一条动态，并专门使用 `BilibiliAPI.get_post_metadata` 方法再次发起请求。这次返回的元数据是针对单条动态的，其中包含了您提到的用户名 (`username` 或 `name`)。
        * **第三优先级**：如果仍未获取到用户名，程序会扫描本地已有的文件夹，通过元数据反向查找是否已存在该用户的文件夹。如果所有方法都失败，最终才会使用用户的数字ID作为文件夹名。

4.  **处理单个动态 (增量下载)**：
    * 程序会逐个处理从上一步骤获取的动态URL。
    * 在处理每个动态之前，它会检查 `config.INCREMENTAL_DOWNLOAD` 开关是否开启。
    * 如果该开关为 `True`，程序会检查该动态对应的最终内容JSON文件是否已存在于本地。如果存在，它会立刻停止处理该用户的所有剩余动态，从而实现增量下载，提高效率。

5.  **元数据获取与保存**：
    * 对于需要下载的新动态，程序会再次调用 `BilibiliAPI` 中的 `get_post_metadata` 方法。
    * 这些原始元数据首先会被保存到本地的 `metadata/step2` 文件夹中。

6.  **图片下载与内容提取**：
    * `PostHandler` 会遍历从上一步获取的元数据，调用 `Downloader` 类中的方法，将每张图片下载到用户的本地文件夹中。
    * **核心功能**：程序会调用 `ContentExtractor` 类中的 `create_content_json_from_local_meta` 方法，从**刚刚保存到本地的 `metadata/step2` 文件中**读取元数据，提取所有关键字段（如URL、ID、发布时间、标题、内容、统计数据等）。
    * 最后，它会将这些提取出的信息整合成一个干净的JSON文件，保存在用户的根文件夹下，与图片文件并列。